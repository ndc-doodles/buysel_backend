
{% extends "base.html" %}
{% load static %}

{% block content %}



<section class="xl:px-24 py-10 mt-20 md:px-16 px-10 max-md:px-6">
  <h2 class="text-4xl font-bold text-gray-800 uppercase text-center mb-2">Properties</h2>
  <p class="text-center text-gray-500 text-sm sm:text-base mb-8">
    Explore our latest listings for sale, rent and lease across your favorite locations.
  </p>

  <!-- Filter Tabs -->
  <div class="grid grid-cols-3 sm:flex sm:flex-nowrap justify-center items-center gap-3 mb-10 mt-10">
    <button onclick="filterCards('all', this)" class="filter-btn min-w-[96px] sm:min-w-[110px] px-4 py-2 bg-[#8bc83f] text-white rounded-lg text-sm sm:text-base">All</button>
    <button onclick="filterCards('Sale', this)" class="filter-btn min-w-[96px] sm:min-w-[110px] px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-[#8bc83f] hover:text-white">Sale</button>
    <button onclick="filterCards('Rent', this)" class="filter-btn min-w-[96px] sm:min-w-[110px] px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-[#8bc83f] hover:text-white">Rent</button>
    <button onclick="filterCards('Lease', this)" class="filter-btn min-w-[96px] sm:min-w-[110px] px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-[#8bc83f] hover:text-white">Lease</button>

    <!-- Sidebar Filter -->
    <button onclick="toggleSidebar()" class="min-w-[96px] sm:min-w-[110px] px-4 py-2 border border-[#8bc83f] text-[#8bc83f] rounded-lg hover:bg-[#f3fef1] flex items-center gap-1">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24">
        <path fill="none" stroke="#8bc83f" stroke-linecap="round" stroke-miterlimit="10" stroke-width="1.5"
          d="M21.25 12H8.895m-4.361 0H2.75m18.5 6.607h-5.748m-4.361 0H2.75m18.5-13.214h-3.105m-4.361 0H2.75m13.214 2.18a2.18 2.18 0 1 0 0-4.36a2.18 2.18 0 0 0 0 4.36Zm-9.25 6.607a2.18 2.18 0 1 0 0-4.36a2.18 2.18 0 0 0 0 4.36Zm6.607 6.608a2.18 2.18 0 1 0 0-4.361a2.18 2.18 0 0 0 0 4.36Z" />
      </svg>
      <span>Filter</span>
    </button>
  </div>

  <p id="no-results-msg" class="text-center text-red-600 text-lg font-semibold hidden mb-6">No properties found.</p>

  <!-- Nearest Property Section -->
  <div class="w-full my-6">
    <button id="findNearestBtn" class="px-4 py-2 bg-[#8bc83f] text-white rounded-lg shadow hover:bg-green-600 transition">
      üìç Find Properties by Distance
    </button>
  </div>

  <div id="nearestPropertyResult" class="my-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 w-full"></div>

  <div id="allProperties" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 w-full">
    {% for property in properties %}
      <div class="property-card bg-white rounded-[18px] shadow-md overflow-hidden relative hover:shadow-lg transition duration-300" data-type="{{ property.purpose.name }}">
        <div class="relative p-2">
          {% if property.images.all %}
            <img src="{{ property.images.first.image.url }}" alt="Property Image" class="w-full h-56 object-cover rounded-[18px] property-image"
              data-images='[{% for img in property.images.all %}"{{ img.image.url }}"{% if not forloop.last %},{% endif %}{% endfor %}]'/>
          {% else %}
            <img src="{% static 'images/demo.png' %}" alt="Property Image" class="w-full h-56 object-cover rounded-[18px] property-image" data-images='["{% static "images/demo.png" %}"]'/>
          {% endif %}
          <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 flex space-x-2 z-10 dots-container">
            {% for img in property.images.all %}
              <span class="dot w-1.5 h-1.5 bg-white rounded-full opacity-70 cursor-pointer"></span>
            {% endfor %}
          </div>
        </div>
        <button id="openShareModal" class="absolute top-3 right-3 group">
  <span class="bg-white p-2 rounded-full inline-block shadow">

    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
              <path fill="#000" fill-rule="evenodd"
                d="M16.5 2.25a3.25 3.25 0 0 0-3.2 3.824L8.57 9.386l-.068.053a3.25 3.25 0 1 0 0 5.121l.068.054l4.73 3.312q-.05.28-.05.574a3.25 3.25 0 1 0 .667-1.973L9.438 13.39c.2-.422.312-.893.312-1.391s-.112-.97-.312-1.391l4.48-3.136A3.25 3.25 0 1 0 16.5 2.25M14.75 5.5a1.75 1.75 0 1 1 3.5 0a1.75 1.75 0 0 1-3.5 0M6.5 10.25a1.75 1.75 0 1 0 0 3.5a1.75 1.75 0 0 0 0-3.5m10 6.5a1.75 1.75 0 1 0 0 3.5a1.75 1.75 0 0 0 0-3.5"
                clip-rule="evenodd" />
            </svg>
  </span>
</button>
        <span class="absolute top-3 left-3 bg-[red] text-white text-[13px] font-semibold px-3 py-1 rounded-lg shadow-sm">{{ property.purpose.name }}</span>
        <div class="p-4">
          <p class="text-[#8b8b8b] font-semibold text-[13px] mb-2">{{property.sq_ft}}</p>
          <h3 class="text-[19px] font-semibold text-gray-800">{{ property.label }}</h3>
          <p class="text-[12px] text-gray-400 whitespace-nowrap overflow-hidden text-ellipsis mb-1">{{property.description}}</p>
          <a href="{% url 'property_detail' property.id %}" class="inline-block text-[12px] text-[#0088FF] underline">View Details</a>
          <hr class="my-2 border-gray-200" />
          {% if property.perprice %}
            <p class="text-[22px] font-semibold text-black">{{ property.perprice }}</p>
          {% endif %}
          <p class="text-[#8b8b8b] text-[13px]">Total {{property.price}}</p>
          <hr class="my-2 border-gray-200" />
          <div class="flex justify-between items-center">
            <p class="text-[15px] text-black flex items-center gap-1">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
        <g fill="none" stroke="#8bc83f" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5">
          <path
            d="M12.56 20.82a.96.96 0 0 1-1.12 0C6.611 17.378 1.486 10.298 6.667 5.182A7.6 7.6 0 0 1 12 3c2 0 3.919.785 5.333 2.181c5.181 5.116.056 12.196-4.773 15.64" />
          <path d="M12 12a2 2 0 1 0 0-4a2 2 0 0 0 0 4" />
        </g>
      </svg>              {{property.land_area}}
            </p>
            <a href="{{property.location}}" class="text-[#0088FF] text-[13px] underline">Directions</a>
          </div>
          <div class="flex items-center justify-between mt-3 space-x-2 w-64">
    <a href="tel:{{property.phone}}"
      class="w-1/2 flex items-center justify-center text-sm bg-[#8bc83f] text-white px-2 py-2 rounded-[12px] transition space-x-1"
      onclick="event.stopPropagation()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
        <path fill="#fff"
          d="M19.95 21q-3.125 0-6.175-1.362t-5.55-3.863t-3.862-5.55T3 4.05q0-.45.3-.75t.75-.3H8.1q.35 0 .625.238t.325.562l.65 3.5q.05.4-.025.675T9.4 8.45L6.975 10.9q.5.925 1.187 1.787t1.513 1.663q.775.775 1.625 1.438T13.1 17l2.35-2.35q.225-.225.588-.337t.712-.063l3.45.7q.35.1.575.363T21 15.9v4.05q0 .45-.3.75t-.75.3" />
      </svg>
      <span class="text-base">Call</span>
    </a>

    <a href="https://wa.me/{{property.whatsapp}}" target="_blank"
      class="w-1/2 flex items-center justify-center text-sm border border-black px-2 py-2 rounded-[12px] transition space-x-1 group bg-white hover:bg-[#8bc83f]"
      onclick="event.stopPropagation()">
      <img src="{% static '/img/whatsapp.png'%}">
      <span class="text-black group-hover:text-white">WhatsApp</span>
    </a>
  </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="flex justify-center mt-10">
    <a href="{% url 'properties' %}">
      <button class="border border-[#8bc83f] px-4 py-2 text-[#8bc83f] hover:text-white hover:bg-[#8bc83f] rounded-md">Explore More</button>
    </a>
  </div>
</section>

<!-- Sidebar Filter -->
<div id="sidebarFilter" class="fixed top-1/2 right-0 w-[350px] h-[600px] bg-white shadow-lg z-50 transform -translate-y-1/2 translate-x-full transition-transform duration-300 ease-in-out overflow-y-auto">
  <div class="p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-semibold text-gray-800">Filter Properties</h3>
      <button onclick="toggleSidebar()" class="text-gray-600 text-2xl hover:text-red-600">&times;</button>
    </div>
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-semibold mb-1">Purpose</label>
        <select id="filterPurpose" class="w-full border border-gray-300 rounded-lg px-3 py-2">
          <option value="">All</option>
          {% for p in purposes %}<option value="{{p.id}}">{{p.name}}</option>{% endfor %}
        </select>
      </div>

      <div>
        <label class="block text-sm font-semibold mb-1">Category</label>
        <select id="filterCategory" class="w-full border border-gray-300 rounded-lg px-3 py-2">
          <option value="">All</option>
          {% for c in categories %}<option value="{{ c.id }}">{{ c.name }}</option>{% endfor %}
        </select>
      </div>

      <div>
        <label class="block text-sm font-semibold mb-1">District</label>
        <select id="filterDistrict" class="w-full border border-gray-300 rounded-lg px-3 py-2">
          <option value="">All</option>
          {% for d in districts %}<option value="{{d}}">{{d}}</option>{% endfor %}
        </select>
      </div>

      <div>
        <label class="block text-sm font-semibold mb-1">City</label>
        <select id="filterCity" class="w-full border border-gray-300 rounded-lg px-3 py-2">
          <option value="">All</option>
          {% for c in cities %}<option value="{{c}}">{{c}}</option>{% endfor %}
        </select>
      </div>

      <div>
        <label class="block text-sm font-semibold mb-1">Price Range</label>
        <div class="flex items-center gap-2">
          <input id="minPrice" type="number" placeholder="Min" class="w-1/2 border border-gray-300 rounded-lg px-3 py-2" />
          <input id="maxPrice" type="number" placeholder="Max" class="w-1/2 border border-gray-300 rounded-lg px-3 py-2" />
        </div>
      </div>

      <div class="pt-2">
        <button id="applyFiltersBtn" class="w-full bg-[#8bc83f] text-white rounded-lg px-4 py-2 hover:bg-green-600 transition">Apply Filters</button>
      </div>
    </div>
  </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function () {

  // --------- Image Slider ---------
  function initSlider(card) {
    const imageEl = card.querySelector(".property-image");
    const dotsContainer = card.querySelector(".dots-container");
    if (!imageEl || !imageEl.dataset.images) return;

    const images = JSON.parse(imageEl.dataset.images);
    let currentIndex = 0;

    // Build dots dynamically
    dotsContainer.innerHTML = images.map(() =>
      `<span class="dot w-1.5 h-1.5 bg-white rounded-full opacity-70 cursor-pointer"></span>`
    ).join("");

    const dots = dotsContainer.querySelectorAll(".dot");

    function changeImage(i) {
      imageEl.src = images[i];
      currentIndex = i;
      dots.forEach((d, idx) => {
        d.classList.toggle("w-2", idx === i);
        d.classList.toggle("h-2", idx === i);
        d.classList.toggle("opacity-100", idx === i);
        d.classList.toggle("opacity-70", idx !== i);
      });
    }

    dots.forEach((dot, i) => dot.addEventListener("click", () => changeImage(i)));
    changeImage(0);
  }

  // --------- Filter Cards by Tab ---------
  window.filterCards = function(type, btn) {
    const cards = document.querySelectorAll("#allProperties .property-card");
    cards.forEach(card => {
      if(type === 'all' || card.dataset.type === type) card.style.display = "block";
      else card.style.display = "none";
    });

    // Update active button
    document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("bg-[#8bc83f]", "text-white"));
    btn.classList.add("bg-[#8bc83f]", "text-white");
  }

  // --------- Build Property Card HTML (AJAX calls use this) ---------
  function buildPropertyCard(p) {
    // Normalize purpose field
    const purposeName = p.purpose_name || p.purpose || '';

    const images = p.images && p.images.length
        ? p.images
        : ["{% static 'images/demo.png' %}"];

    return `
    <div class="property-card bg-white rounded-[18px] shadow-md overflow-hidden relative hover:shadow-lg transition duration-300" data-type="${purposeName}">
        <div class="relative p-2">
          <img src="${images[0]}" alt="Property Image" class="property-image w-full h-56 object-cover rounded-[18px]" data-images='${JSON.stringify(images)}'/>
          <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 flex space-x-2 z-10 dots-container"></div>
        </div>

        <!-- Share Button -->
        <button class="absolute top-3 right-3 group">
          <span class="bg-white p-2 rounded-full inline-block shadow">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
              <path fill="#000" fill-rule="evenodd"
                d="M16.5 2.25a3.25 3.25 0 0 0-3.2 3.824L8.57 9.386l-.068.053a3.25 3.25 0 1 0 0 5.121l.068.054l4.73 3.312q-.05.28-.05.574a3.25 3.25 0 1 0 .667-1.973L9.438 13.39c.2-.422.312-.893.312-1.391s-.112-.97-.312-1.391l4.48-3.136A3.25 3.25 0 1 0 16.5 2.25M14.75 5.5a1.75 1.75 0 1 1 3.5 0a1.75 1.75 0 0 1-3.5 0M6.5 10.25a1.75 1.75 0 1 0 0 3.5a1.75 1.75 0 0 0 0-3.5m10 6.5a1.75 1.75 0 1 0 0 3.5a1.75 1.75 0 0 0 0-3.5"
                clip-rule="evenodd" />
            </svg>
          </span>
        </button>

        <!-- Purpose -->
        <span class="absolute top-3 left-3 bg-[red] text-white text-[13px] font-semibold px-3 py-1 rounded-lg shadow-sm">${purposeName}</span>

        <div class="p-4">
          <p class="text-[#8b8b8b] font-semibold text-[13px] mb-2">${p.sq_ft || ''}</p>
          <h3 class="text-[19px] font-semibold text-gray-800">${p.label}</h3>
          <p class="text-[12px] text-gray-400 whitespace-nowrap overflow-hidden text-ellipsis mb-1">${p.description || p.desc || ''}</p>

          <a href="/property/${p.id}" class="inline-block text-[12px] text-[#0088FF] underline">View Details</a>

          <hr class="my-2 border-gray-200" />
          ${p.perprice ? `<p class="text-[22px] font-semibold text-black">${p.perprice}</p>` : ""}
          <p class="text-[#8b8b8b] text-[13px]">Total ${p.price || ''}</p>
          <hr class="my-2 border-gray-200" />

          <div class="flex justify-between items-center">
            <p class="text-[15px] text-black flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                <g fill="none" stroke="#8bc83f" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5">
                  <path d="M12.56 20.82a.96.96 0 0 1-1.12 0C6.611 17.378 1.486 10.298 6.667 5.182A7.6 7.6 0 0 1 12 3c2 0 3.919.785 5.333 2.181c5.181 5.116.056 12.196-4.773 15.64" />
                  <path d="M12 12a2 2 0 1 0 0-4a2 2 0 0 0 0 4" />
                </g>
              </svg>
              ${p.land_area || ''}
            </p>
            <a href="${p.location || '#'}" class="text-[#0088FF] text-[13px] underline">Directions</a>
          </div>

          <!-- Call & WhatsApp -->
          <div class="flex items-center justify-between mt-3 space-x-2 w-64">
            <a href="tel:${p.phone || '1234567890'}"
              class="w-1/2 flex items-center justify-center text-sm bg-[#8bc83f] text-white px-2 py-2 rounded-[12px] transition space-x-1"
              onclick="event.stopPropagation()">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                <path fill="#fff"
                  d="M19.95 21q-3.125 0-6.175-1.362t-5.55-3.863t-3.862-5.55T3 4.05q0-.45.3-.75t.75-.3H8.1q.35 0 .625.238t.325.562l.65 3.5q.05.4-.025.675T9.4 8.45L6.975 10.9q.5.925 1.187 1.787t1.513 1.663q.775.775 1.625 1.438T13.1 17l2.35-2.35q.225-.225.588-.337t.712-.063l3.45.7q.35.1.575.363T21 15.9v4.05q0 .45-.3.75t-.75.3" />
              </svg>
              <span class="text-base">Call</span>
            </a>

            <a href="https://wa.me/${p.phone || '1234567890'}" target="_blank"
              class="w-1/2 flex items-center justify-center text-sm border border-black px-2 py-2 rounded-[12px] transition space-x-1 group bg-white hover:bg-[#8bc83f]"
              onclick="event.stopPropagation()">
              <img src="{% static 'img/whatsapp.png' %}">
              <span class="text-black group-hover:text-white">WhatsApp</span>
            </a>
          </div>
        </div>
      </div>
    `;
  }

  // --------- Nearest Properties (AJAX) ---------
  const nearestBtn = document.getElementById("findNearestBtn");
  const resultDiv = document.getElementById("nearestPropertyResult");
  const allPropsDiv = document.getElementById("allProperties");

  nearestBtn?.addEventListener("click", () => {
    if (!navigator.geolocation) return alert("Geolocation not supported");

    navigator.geolocation.getCurrentPosition(pos => {
      fetch(`/nearest-properties/?lat=${pos.coords.latitude}&lng=${pos.coords.longitude}`)
        .then(res => res.json())
        .then(data => {
          allPropsDiv.style.display = "none";
          resultDiv.innerHTML = "";

          if (!data.length || data.error) {
            resultDiv.innerHTML = `<p class="text-red-500">No nearby properties found.</p>`;
          } else {
            data.forEach(p => resultDiv.innerHTML += buildPropertyCard(p));
            document.querySelectorAll("#nearestPropertyResult .property-card").forEach(initSlider);
          }
        })
        .catch(err => resultDiv.innerHTML = `<p class="text-red-500">Error: ${err.message}</p>`);
    });
  });

  // --------- Apply Filters (AJAX) ---------
  const applyBtn = document.getElementById("applyFiltersBtn");
  applyBtn?.addEventListener("click", () => {
    const params = new URLSearchParams({
      purpose: document.getElementById("filterPurpose").value,
      category: document.getElementById("filterCategory").value,
      district: document.getElementById("filterDistrict").value,
      city: document.getElementById("filterCity").value,
      min_price: document.getElementById("minPrice").value || "",
      max_price: document.getElementById("maxPrice").value || ""
    });

    fetch(`/filter-properties/?${params.toString()}`)
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById("allProperties");
        container.innerHTML = "";
        document.getElementById("no-results-msg").classList.add("hidden");

        if (!data.length || data.error) {
          document.getElementById("no-results-msg").classList.remove("hidden");
        } else {
          data.forEach(p => container.innerHTML += buildPropertyCard(p));
          document.querySelectorAll("#allProperties .property-card").forEach(initSlider);
          allPropsDiv.style.display = "grid";
          resultDiv.innerHTML = "";
        }
      })
      .catch(err => console.error(err));
  });

  // --------- Toggle Sidebar ---------
  window.toggleSidebar = function () {
    document.getElementById("sidebarFilter").classList.toggle("translate-x-full");
  }

  // --------- Initialize Sliders on Page Load ---------
  document.querySelectorAll("#allProperties .property-card").forEach(initSlider);

});
</script>








    <script src="./asset/js/main.js"></script>
{% endblock%}